{"version":3,"sources":["uni-app:///main.js","webpack:///D:/hbuilder/campus_run_vue/subpkg/chat/chat.vue?8e9d","webpack:///D:/hbuilder/campus_run_vue/subpkg/chat/chat.vue?56be","webpack:///D:/hbuilder/campus_run_vue/subpkg/chat/chat.vue?a69f","webpack:///D:/hbuilder/campus_run_vue/subpkg/chat/chat.vue?e8b5","uni-app:///subpkg/chat/chat.vue","webpack:///D:/hbuilder/campus_run_vue/subpkg/chat/chat.vue?11c4","webpack:///D:/hbuilder/campus_run_vue/subpkg/chat/chat.vue?f50f"],"names":["wx","__webpack_require_UNI_MP_PLUGIN__","__webpack_require__","createPage","Page","computed","onLoad","console","onUnload","clearInterval","data","msgs","imgMsg","scrollToView","windowHeight","paddingHeight","animationData","curPage","loading","isLoading","socketTask","timer","reconnectTimer","socketOpen","isUnLoad","maxTaskCount","queryObj","page","size","inboxHash","total","methods","getChatRecords","uni","res","msg","getMsg","msgsArr","oldTime","arr","item","nextPage","getTime","changeTime","previewImg","current","urls","success","fail","updateHeight","goToBottom","setTimeout","input","message","uploadPhoto","filePaths","self","connectSocket","url","header","type","complete","that","reconnect","sendSocketMessage","resolve","reject","heart","closeSocket"],"mappings":";;;;;;;;;;;;;AAAA;AAGA;AACA;AAHA;AACAA,EAAE,CAACC,iCAAiC,GAAGC,mBAAmB;AAG1DC,UAAU,CAACC,aAAI,CAAC,C;;;;;;;;;;;;;ACLhB;AAAA;AAAA;AAAA;AAAA;AAAA;AAAiH;AACjH;AACwD;AACL;AACc;;;AAGjE;AACyL;AACzL,gBAAgB,sMAAU;AAC1B,EAAE,0EAAM;AACR,EAAE,+EAAM;AACR,EAAE,wFAAe;AACjB;AACA;AACA;AACA;AACA;AACA,EAAE,mFAAU;AACZ;AACA;;AAEA;AACe,gF;;;;;;;;;;;;ACvBf;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;;;;;;;;;;;;ACAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA,aAAa,8LAEN;AACP,KAAK;AACL;AACA,CAAC;AACD;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,GAAG;AACH;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;;ACjCA;AAAA;AAAA;AAAA;AAA+sB,CAAgB,2uBAAG,EAAC,C;;;;;;;;;;;;;;;;;;;;;;;AC8DnuB;AACA;AACA;AAEA;AAAA;AAAA,eACA;EACAC,4BACA,qDACA;EACAC;IACA;IACA;IACA;IACAC;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;EACA;EACAC;IACA;IACAC;IACAA;IACA;EACA;EACAC;IACA;MACAC;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;MAAA,CACA;MACAC;MACAC;MACAC;MACAC;MACAC;MACA;MACAC;MACAC;MACAC;MACAC;MACAC;MACAC;MACAC;MACAC;MACAC;MACAC;QACAC;QACAC;QACAC;MACA;MACAC;IAEA;EACA;EACAC;IACAC;MAAA;MAAA;QAAA;QAAA;UAAA;YAAA;cAAA;gBACA;gBAAA;gBAAA,OACAC;cAAA;gBAAA;gBAAAC;gBACA;gBACA3B;gBAAA,MAEA2B;kBAAA;kBAAA;gBAAA;gBAAA,iCACAD;cAAA;gBAGA;gBACAE;gBACA5B;gBACA;gBACA;gBAEA;cAAA;cAAA;gBAAA;YAAA;UAAA;QAAA;MAAA;IACA;IACA;IACA6B;MACA;MACA;MACAC;MACA;MACA;MACA;MACA;MACA;MACA;MACA;MAEA;MACA;MACA;QACAC;MACA;QACA;MACA;MAEAD;QACA;QACA;UACAE;QACA;QACAhC;QACA;UACAiC;QACA;UACAA,oHACAA;QACA;QACAA;QACAF;MACA;MACA;QACA;QACA;QACA;UACA;QACA;MACA;QACA7B;QACA;QACA;;QAEA;QACA;QACA;MACA;MACA;IAEA;IACA;IACAgC;MACAlC;MACA;MACA;QACAA;QACA;MACA;MACA;MACA;MACA;MACA;MACA;MACA;MACA;MACA;MACA;MACA;MACA;MACA;;MAEA;MACA;MACA;MACA;MACA;MACA;MACA;;MAEA;MACA;MACA;MACA;MACA;MACA;MACA;MACA;MACA;MACA;MACA;MACA;MACA;MACA;MACA;MACA;MACA;MACA;MACA;MACA;MACA;MACA;MACA;MACA;MACA;IACA;IACAmC;MACA;MACA;MACAnC;MACA;QACA;MACA;QACA;MACA;IACA;IACA;IACAoC;MACA;IACA;IACA;IACAC;MACA;QAEA;UACA;QACA;MACA;MACArC;MACA0B;QACAY;QACAC;QACAC;UACAxC;QACA;QACAyC;UACAzC;QACA;MACA;IAGA;IACA0C;MACA1C;MACA;MACA;IACA;IACA;IACA2C;MAAA;MACA3C;MACA;MACA4C;QACA;UACA;QACA;MACA;IAEA;IACA;IACAC;MAEA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;MACA;MACA;MACA;MACA;MACAC;MACA;MACA9C;MAEA;QACA;QACA;UACA;UACA;UACA;UACA;QACA;MACA;MACA;MACA;QACAA;QACAA;MAEA;QACAA;QACAA;MACA;MACA;MACA;MACA;IAGA;IACA+C;MACA;MACA;MACAC;QACA;UACA;UACA;UACA;UACA;UACA;UACA;UACA;QACA;QACAC;QACA;QACAH;QACAG;QAEA;UACA;UACA;YACA;YACA;YACA;YACA;UACA;QACA;QAEAA;UACAjD;UACAA;QAEA;UACAA;UACAA;QACA;MACA;MACA;IACA;IACAkD;MACA;MACA;QACAC;QACAC;UACA;UACA;QACA;QACA;QACA;QACA;QACAjD;UACA;YACAkD;UACA;QACA;QACAC;UACAtD;QACA;QACAyC;UACAzC;QACA;QACAwC;UACAxC;QACA;MACA;MAEA;QACAA;QACAE;QACA;QACAqD;MACA;MAEA;QACA;QACA;QACA;QACA;;QAEA;QACA;QACA;QACAA;QACA;QACA3B;QAEA;UACA2B;QACA;QACAA;QACA;MAEA;;MAEA;MACA;MACA;MACA;QACAvD;QACAA;QACAuD;QACA;QACA;MACA;;MAEA;QACAvD;QACAE;QACAqD;;QAEA;QACA;QACA;UACAvD;UACAuD;QACA;MACA;IAGA;IACA;IACAC;MAAA;MACAxD;MACA;MACA;QACAA;QACA;UACA;QACA;MACA;MACA;IACA;IACA;IACAyD;MAAA;MACAzD;MACAA;MACA;MACA;QACA;UACAoD;YACA;YACA;UACA;UACAjD;UACAqC;YACAxC;YACA0D;UACA;UACAjB;YACAzC;YACAA;YACA2D;UACA;QACA;MACA;IACA;IACAC;MACA;MACA1D;MACA;MACA;QACA;MACA;MACA;QACAqD;UACAvD;QACA;UACAA;UACAA;QACA;MACA;IACA;IACA;IACA6D;MACA;MACA;QACA;MACA;MACA;QACArB;UACAxC;UACAA;QACA;QACAyC;UACAzC;UACAA;QACA;MACA;IACA;EACA;AACA;AAAA,2B;;;;;;;;;;;;;AC9oBA;AAAA;AAAA;AAAA;AAAk1C,CAAgB,8zCAAG,EAAC,C;;;;;;;;;;;ACAt2C;AACA,OAAO,KAAU,EAAE,kBAKd","file":"subpkg/chat/chat.js","sourcesContent":["import 'uni-pages';\n// @ts-ignore\nwx.__webpack_require_UNI_MP_PLUGIN__ = __webpack_require__;\nimport Vue from 'vue'\nimport Page from './subpkg/chat/chat.vue'\ncreatePage(Page)","import { render, staticRenderFns, recyclableRender, components } from \"./chat.vue?vue&type=template&id=19940a7a&\"\nvar renderjs\nimport script from \"./chat.vue?vue&type=script&lang=js&\"\nexport * from \"./chat.vue?vue&type=script&lang=js&\"\nimport style0 from \"./chat.vue?vue&type=style&index=0&lang=scss&\"\n\n\n/* normalize component */\nimport normalizer from \"!../../../HBuilderX.3.6.4.20220922/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/vue-cli-plugin-uni/packages/vue-loader/lib/runtime/componentNormalizer.js\"\nvar component = normalizer(\n  script,\n  render,\n  staticRenderFns,\n  false,\n  null,\n  null,\n  null,\n  false,\n  components,\n  renderjs\n)\n\ncomponent.options.__file = \"subpkg/chat/chat.vue\"\nexport default component.exports","export * from \"-!../../../HBuilderX.3.6.4.20220922/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/vue-cli-plugin-uni/packages/vue-loader/lib/loaders/templateLoader.js??vue-loader-options!../../../HBuilderX.3.6.4.20220922/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/vue-cli-plugin-uni/packages/webpack-preprocess-loader/index.js??ref--17-0!../../../HBuilderX.3.6.4.20220922/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/webpack-uni-mp-loader/lib/template.js!../../../HBuilderX.3.6.4.20220922/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/vue-cli-plugin-uni/packages/webpack-uni-app-loader/page-meta.js!../../../HBuilderX.3.6.4.20220922/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/vue-cli-plugin-uni/packages/vue-loader/lib/index.js??vue-loader-options!../../../HBuilderX.3.6.4.20220922/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/webpack-uni-mp-loader/lib/style.js!./chat.vue?vue&type=template&id=19940a7a&\"","var components\ntry {\n  components = {\n    mySubmit: function () {\n      return import(\n        /* webpackChunkName: \"components/my-submit/my-submit\" */ \"@/components/my-submit/my-submit.vue\"\n      )\n    },\n  }\n} catch (e) {\n  if (\n    e.message.indexOf(\"Cannot find module\") !== -1 &&\n    e.message.indexOf(\".vue\") !== -1\n  ) {\n    console.error(e.message)\n    console.error(\"1. 排查组件名称拼写是否正确\")\n    console.error(\n      \"2. 排查组件是否符合 easycom 规范，文档：https://uniapp.dcloud.net.cn/collocation/pages?id=easycom\"\n    )\n    console.error(\n      \"3. 若组件不符合 easycom 规范，需手动引入，并在 components 中注册该组件\"\n    )\n  } else {\n    throw e\n  }\n}\nvar render = function () {\n  var _vm = this\n  var _h = _vm.$createElement\n  var _c = _vm._self._c || _h\n}\nvar recyclableRender = false\nvar staticRenderFns = []\nrender._withStripped = true\n\nexport { render, staticRenderFns, recyclableRender, components }","import mod from \"-!../../../HBuilderX.3.6.4.20220922/HBuilderX/plugins/uniapp-cli/node_modules/babel-loader/lib/index.js!../../../HBuilderX.3.6.4.20220922/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/vue-cli-plugin-uni/packages/webpack-preprocess-loader/index.js??ref--13-1!../../../HBuilderX.3.6.4.20220922/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/webpack-uni-mp-loader/lib/script.js!../../../HBuilderX.3.6.4.20220922/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/vue-cli-plugin-uni/packages/vue-loader/lib/index.js??vue-loader-options!../../../HBuilderX.3.6.4.20220922/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/webpack-uni-mp-loader/lib/style.js!./chat.vue?vue&type=script&lang=js&\"; export default mod; export * from \"-!../../../HBuilderX.3.6.4.20220922/HBuilderX/plugins/uniapp-cli/node_modules/babel-loader/lib/index.js!../../../HBuilderX.3.6.4.20220922/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/vue-cli-plugin-uni/packages/webpack-preprocess-loader/index.js??ref--13-1!../../../HBuilderX.3.6.4.20220922/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/webpack-uni-mp-loader/lib/script.js!../../../HBuilderX.3.6.4.20220922/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/vue-cli-plugin-uni/packages/vue-loader/lib/index.js??vue-loader-options!../../../HBuilderX.3.6.4.20220922/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/webpack-uni-mp-loader/lib/style.js!./chat.vue?vue&type=script&lang=js&\"","<!-- 聊天页面 -->\r\n<template>\r\n\t<view class=\"content\">\r\n\t\t<scroll-view class=\"chat\" scroll-y=\"true\" :scroll-with-animation=\"false\" @scrolltoupper=\"nextPage()\"\r\n\t\t\t:scroll-into-view=\"scrollToView\" :style=\"{height: windowHeight + 'px'}\">\r\n\t\t\t<view class=\"chat-main\" :style=\"{paddingBottom: paddingHeight + 'px'}\">\r\n\t\t\t\t<view class=\"loading\" :animation=\"animationData\" v-show=\"isLoading\">\r\n\t\t\t\t\t<image src=\"../../static/chat_icons/loading3.png\" class=\"loading-image\"></image>\r\n\t\t\t\t</view>\r\n\t\t\t\t<view class=\"chat-ls\" v-for=\"(item, i) in msgs\" :key=\"i\" :id=\"'msg'+ item.createTime\">\r\n\t\t\t\t\t<view class=\"chat-time\" v-if=\"item.showTime !== ''\">{{item.showTime}}</view>\r\n\t\t\t\t\t<!-- 判断是否为自己，后面再改 -->\r\n\t\t\t\t\t<view class=\"msg-m msg-left\" v-if=\"item.senderId !== userinfo.openId\">\r\n\t\t\t\t\t\t<image :src=\"item.senderHeadPortrait\" class=\"user-img\"></image>\r\n\t\t\t\t\t\t<!-- 文字 -->\r\n\t\t\t\t\t\t<view class=\"message\" v-if=\"item.messageType === 0\">\r\n\r\n\t\t\t\t\t\t\t<view class=\"msg-text\">{{item.messageContent}}</view>\r\n\t\t\t\t\t\t</view>\r\n\t\t\t\t\t\t<!-- 图片 -->\r\n\t\t\t\t\t\t<view class=\"message\" v-if=\"item.messageType === 1\">\r\n\t\t\t\t\t\t\t<image :src=\"item.messageContent\" class=\"msg-img\" mode=\"widthFix\" @tap=\"previewImg(item.messageContent)\">\r\n\t\t\t\t\t\t\t</image>\r\n\t\t\t\t\t\t\t<!-- <view class=\"msg-text\">{{item.message}}</view> -->\r\n\t\t\t\t\t\t</view>\r\n\t\t\t\t\t</view>\r\n\t\t\t\t\t<view class=\"msg-m msg-right\" v-if=\"item.senderId === userinfo.openId\">\r\n\t\t\t\t\t\t<image :src=\"item.senderHeadPortrait\" class=\"user-img\"></image>\r\n\t\t\t\t\t\t<!-- 文字 -->\r\n\t\t\t\t\t\t<view class=\"message\" v-if=\"item.messageType === 0\">\r\n\r\n\t\t\t\t\t\t\t<view class=\"msg-text\">{{item.messageContent}}</view>\r\n\t\t\t\t\t\t</view>\r\n\t\t\t\t\t\t<!-- 图片 -->\r\n\t\t\t\t\t\t<view class=\"message\" v-if=\"item.messageType === 1\">\r\n\t\t\t\t\t\t\t<image :src=\"item.messageContent\" class=\"msg-img\" mode=\"widthFix\" @tap=\"previewImg(item.messageContent)\">\r\n\t\t\t\t\t\t\t</image>\r\n\t\t\t\t\t\t\t<!-- <view class=\"msg-text\">{{item.message}}</view> -->\r\n\t\t\t\t\t\t</view>\r\n\r\n\t\t\t\t\t</view>\r\n\t\t\t\t</view>\r\n\t\t\t\t<!-- <view class=\"chat-ls\">\r\n\t\t\t\t\t<view class=\"chat-time\">12:32</view>\r\n\t\t\t\t\t<view class=\"msg-m msg-right\">\r\n\t\t\t\t\t\t<view class=\"message\">\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t<view class=\"msg-text\">你好啊，我的朋友，多日不见</view>\r\n\t\t\t\t\t\t\t<image src=\"../../static/example/avatar.jpg\" class=\"user-img\"></image>\r\n\t\t\t\t\t\t</view>\t\r\n\t\t\t\t\t</view>\r\n\t\t\t\t</view> -->\r\n\t\t\t\t<!-- <view class=\"pad\"></view> -->\r\n\t\t\t</view>\r\n\t\t</scroll-view>\r\n\r\n\t\t<!-- 发送框 -->\r\n\t\t<my-submit @updateHeight=\"updateHeight\" @input=\"input\" @uploadPhoto=\"uploadPhoto\"></my-submit>\r\n\t</view>\r\n</template>\r\n\r\n<script>\r\n\timport dateTool from '../../tools/date_tool.js';\r\n\timport user from '../../store/user';\r\n\timport {\r\n\t\tmapState\r\n\t} from 'vuex';\r\n\texport default {\r\n\t\tcomputed: {\r\n\t\t\t...mapState('m_user', ['token', 'userinfo'])\r\n\t\t},\r\n\t\tonLoad(options) {\r\n\t\t\tthis.queryObj.inboxHash = options.inboxHash\r\n\t\t//\tthis.nextPage()\r\n\t\t\tlet height = uni.getWindowInfo().windowHeight\r\n\t\t\tconsole.log(height)\r\n\t\t\t// let msgs = [{\r\n\t\t\t// \t\t\"id\": \"1\",\r\n\t\t\t// \t\t\"userId\": \"1\",\r\n\t\t\t// \t\t\"imgUrl\": \"../../static/example/avatar.jpg\",\r\n\t\t\t// \t\t// \"message\": '../../static/example/avatar.jpg',\r\n\t\t\t// \t\t\"message\": 'https://img2020.cnblogs.com/blog/2543831/202112/2543831-20211208111755384-1390104080.png',\r\n\t\t\t// \t\t\"type\": 1,\r\n\t\t\t// \t\t\"time\": new Date() - 1000 * 60 * 6\r\n\t\t\t// \t},\r\n\t\t\t// \t{\r\n\t\t\t// \t\t\"id\": \"2\",\r\n\t\t\t// \t\t\"userId\": \"2\",\r\n\t\t\t// \t\t\"imgUrl\": \"../../static/example/avatar.jpg\",\r\n\t\t\t// \t\t\"message\": '咋说呢',\r\n\t\t\t// \t\t\"type\": 0,\r\n\t\t\t// \t\t\"time\": new Date() - 1000 * 60 * 7\r\n\t\t\t// \t},\r\n\t\t\t// \t{\r\n\t\t\t// \t\t\"id\": \"3\",\r\n\t\t\t// \t\t\"userId\": \"1\",\r\n\t\t\t// \t\t\"imgUrl\": \"../../static/example/avatar.jpg\",\r\n\t\t\t// \t\t// \"message\": '../../static/example/example.jpg',\r\n\t\t\t// \t\t\"message\": 'https://img-blog.csdn.net/20181002101903185?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MTc5NjYzMQ==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70',\r\n\t\t\t// \t\t\"type\": 1,\r\n\t\t\t// \t\t\"time\": new Date() - 1000 * 60 * 60 * 24\r\n\t\t\t// \t},\r\n\t\t\t// \t{\r\n\t\t\t// \t\t\"id\": \"4\",\r\n\t\t\t// \t\t\"userId\": \"2\",\r\n\t\t\t// \t\t\"imgUrl\": \"../../static/example/avatar.jpg\",\r\n\t\t\t// \t\t// \"message\": '../../static/example/example.jpg',\r\n\t\t\t// \t\t\"message\": 'https://img-blog.csdn.net/20181002101903185?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MTc5NjYzMQ==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70',\r\n\t\t\t// \t\t\"type\": 1,\r\n\t\t\t// \t\t\"time\": new Date() - 1000 * 60 * 60 * 24 * 365 * 2\r\n\t\t\t// \t},\r\n\t\t\t// \t{\r\n\t\t\t// \t\t\"id\": \"5\",\r\n\t\t\t// \t\t\"userId\": \"1\",\r\n\t\t\t// \t\t\"imgUrl\": \"../../static/example/avatar.jpg\",\r\n\t\t\t// \t\t// \"message\": '../../static/example/example.jpg',\r\n\t\t\t// \t\t\"message\": 'https://img-blog.csdn.net/20181002101903185?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MTc5NjYzMQ==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70',\r\n\t\t\t// \t\t\"type\": 1,\r\n\t\t\t// \t\t\"time\": new Date() - 1000 * 60 * 60 * 24 * 365 * 2 * 2\r\n\t\t\t// \t},\r\n\t\t\t// \t{\r\n\t\t\t// \t\t\"id\": \"6\",\r\n\t\t\t// \t\t\"userId\": \"2\",\r\n\t\t\t// \t\t\"imgUrl\": \"../../static/example/avatar.jpg\",\r\n\t\t\t// \t\t// \"message\": '../../static/example/example.jpg',\r\n\t\t\t// \t\t\"message\": 'https://img-blog.csdn.net/20181002101903185?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MTc5NjYzMQ==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70',\r\n\t\t\t// \t\t\"type\": 1,\r\n\t\t\t// \t\t\"time\": new Date() - 1000 * 60 * 60 * 24 * 365 * 2 * 2\r\n\t\t\t// \t},\r\n\t\t\t// \t{\r\n\t\t\t// \t\t\"id\": \"7\",\r\n\t\t\t// \t\t\"userId\": \"2\",\r\n\t\t\t// \t\t\"imgUrl\": \"../../static/example/avatar.jpg\",\r\n\t\t\t// \t\t// \"message\": '../../static/example/example.jpg',\r\n\t\t\t// \t\t\"message\": 'https://img-blog.csdn.net/20181002101903185?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MTc5NjYzMQ==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70',\r\n\t\t\t// \t\t\"type\": 1,\r\n\t\t\t// \t\t\"time\": new Date() - 1000 * 60 * 60 * 24 * 365 * 2 * 2\r\n\t\t\t// \t}\r\n\t\t\t// ]\r\n\t\t\t//this.getMsg(1, msgs)\r\n\t\t\tthis.getChatRecords()\r\n\t\t\tthis.windowHeight = height\r\n\t\t\tthis.connectSocket()\r\n\t\t},\r\n\t\tonUnload() {\r\n\t\t\tthis.isUnLoad = true\r\n\t\t\tclearInterval(this.reconnectTimer)\r\n\t\t\tclearInterval(this.timer)\r\n\t\t\tthis.closeSocket()\r\n\t\t},\r\n\t\tdata() {\r\n\t\t\treturn {\r\n\t\t\t\tmsgs: [\r\n\t\t\t\t\t// {\r\n\t\t\t\t\t// \t\"id\": \"1\",\r\n\t\t\t\t\t// \t\"userId\": \"1\",\r\n\t\t\t\t\t// \t\"imgUrl\": \"../../static/example/avatar.jpg\",\r\n\t\t\t\t\t// \t// \"message\": '../../static/example/avatar.jpg',\r\n\t\t\t\t\t// \t\"message\": 'https://img2020.cnblogs.com/blog/2543831/202112/2543831-20211208111755384-1390104080.png',\r\n\t\t\t\t\t// \t\"type\": 1,\r\n\t\t\t\t\t// \t\"time\": new Date() - 1000 * 60 * 6\r\n\t\t\t\t\t// },\r\n\t\t\t\t\t// {\r\n\t\t\t\t\t// \t\"id\": \"2\",\r\n\t\t\t\t\t// \t\"userId\": \"2\",\r\n\t\t\t\t\t// \t\"imgUrl\": \"../../static/example/avatar.jpg\",\r\n\t\t\t\t\t// \t\"message\": '咋说呢',\r\n\t\t\t\t\t// \t\"type\": 0,\r\n\t\t\t\t\t// \t\"time\": new Date() - 1000 * 60 * 7\r\n\t\t\t\t\t// },\r\n\t\t\t\t\t// {\r\n\t\t\t\t\t// \t\"id\": \"3\",\r\n\t\t\t\t\t// \t\"userId\": \"1\",\r\n\t\t\t\t\t// \t\"imgUrl\": \"../../static/example/avatar.jpg\",\r\n\t\t\t\t\t// \t// \"message\": '../../static/example/example.jpg',\r\n\t\t\t\t\t// \t\"message\": 'https://img-blog.csdn.net/20181002101903185?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MTc5NjYzMQ==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70',\r\n\t\t\t\t\t// \t\"type\": 1,\r\n\t\t\t\t\t// \t\"time\": new Date() - 1000 * 60 * 60 * 24 \r\n\t\t\t\t\t// },\r\n\t\t\t\t\t// {\r\n\t\t\t\t\t// \t\"id\": \"4\",\r\n\t\t\t\t\t// \t\"userId\": \"2\",\r\n\t\t\t\t\t// \t\"imgUrl\": \"../../static/example/avatar.jpg\",\r\n\t\t\t\t\t// \t// \"message\": '../../static/example/example.jpg',\r\n\t\t\t\t\t// \t\"message\": 'https://img-blog.csdn.net/20181002101903185?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MTc5NjYzMQ==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70',\r\n\t\t\t\t\t// \t\"type\": 1,\r\n\t\t\t\t\t// \t\"time\": new Date() - 1000 * 60 * 60 * 24 * 365 * 2\r\n\t\t\t\t\t// },\r\n\t\t\t\t\t// {\r\n\t\t\t\t\t// \t\"id\": \"5\",\r\n\t\t\t\t\t// \t\"userId\": \"1\",\r\n\t\t\t\t\t// \t\"imgUrl\": \"../../static/example/avatar.jpg\",\r\n\t\t\t\t\t// \t// \"message\": '../../static/example/example.jpg',\r\n\t\t\t\t\t// \t\"message\": 'https://img-blog.csdn.net/20181002101903185?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MTc5NjYzMQ==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70',\r\n\t\t\t\t\t// \t\"type\": 1,\r\n\t\t\t\t\t// \t\"time\": new Date() - 1000 * 60 * 60 * 24 * 365 * 2 * 2\r\n\t\t\t\t\t// },\r\n\t\t\t\t\t// {\r\n\t\t\t\t\t// \t\"id\": \"6\",\r\n\t\t\t\t\t// \t\"userId\": \"2\",\r\n\t\t\t\t\t// \t\"imgUrl\": \"../../static/example/avatar.jpg\",\r\n\t\t\t\t\t// \t// \"message\": '../../static/example/example.jpg',\r\n\t\t\t\t\t// \t\"message\": 'https://img-blog.csdn.net/20181002101903185?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MTc5NjYzMQ==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70',\r\n\t\t\t\t\t// \t\"type\": 1,\r\n\t\t\t\t\t// \t\"time\": new Date() - 1000 * 60 * 60 * 24 * 365 * 2 * 2\r\n\t\t\t\t\t// },\r\n\t\t\t\t\t// {\r\n\t\t\t\t\t// \t\"id\": \"7\",\r\n\t\t\t\t\t// \t\"userId\": \"2\",\r\n\t\t\t\t\t// \t\"imgUrl\": \"../../static/example/avatar.jpg\",\r\n\t\t\t\t\t// \t// \"message\": '../../static/example/example.jpg',\r\n\t\t\t\t\t// \t\"message\": 'https://img-blog.csdn.net/20181002101903185?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MTc5NjYzMQ==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70',\r\n\t\t\t\t\t// \t\"type\": 1,\r\n\t\t\t\t\t// \t\"time\": new Date() - 1000 * 60 * 60 * 24 * 365 * 2 * 2\r\n\t\t\t\t\t// }\r\n\t\t\t\t],\r\n\t\t\t\timgMsg: [],\r\n\t\t\t\tscrollToView: '',\r\n\t\t\t\twindowHeight: '',\r\n\t\t\t\tpaddingHeight: '60',\r\n\t\t\t\tanimationData: {},\r\n\t\t\t\t//页码\r\n\t\t\t\tcurPage: 0,\r\n\t\t\t\tloading: '',\r\n\t\t\t\tisLoading: false,\r\n\t\t\t\tsocketTask: '',\r\n\t\t\t\ttimer: '',\r\n\t\t\t\treconnectTimer: '',\r\n\t\t\t\tsocketOpen: false,\r\n\t\t\t\tisUnLoad: false,\r\n\t\t\t\tmaxTaskCount: 5,\r\n\t\t\t\tqueryObj: {\r\n\t\t\t\t\tpage: 1,\r\n\t\t\t\t\tsize: 8,\r\n\t\t\t\t\tinboxHash: ''\r\n\t\t\t\t},\r\n\t\t\t\ttotal: 0,\r\n\r\n\t\t\t};\r\n\t\t},\r\n\t\tmethods: {\r\n\t\t\tasync getChatRecords() {\r\n\t\t\t\tthis.isLoading = true\r\n\t\t\t\tconst {data : res} = await uni.$http.get('/api/chat-record/getChatRecord', this.queryObj)\r\n\t\t\t\tthis.isLoading = false\r\n\t\t\t\tconsole.log(res);\r\n\t\t\t\t\r\n\t\t\t\tif (res.code !== 20000) {\r\n\t\t\t\t\treturn uni.$showMsg()\r\n\t\t\t\t}\r\n\t\t\t\t\r\n\t\t\t\t//this.list = [...this.list, ...res.data.data.list]\r\n\t\t\t\tconst msg = res.data.data.list;\r\n\t\t\t\tconsole.log(JSON.stringify(msg))\r\n\t\t\t\tthis.total = res.data.data.totalCount\r\n\t\t\t\tthis.isLoading = false;\r\n\t\t\t\t\r\n\t\t\t\tthis.getMsg(msg)\r\n\t\t\t},\r\n\t\t\t//获取聊天数据\r\n\t\t\tgetMsg(messages) {\r\n\t\t\t\t//clearInterval(this.loading)\r\n\t\t\t\tlet msgsArr = messages\r\n\t\t\t\tmsgsArr.reverse()\r\n\t\t\t\t// this.imgMsg = this.msgs.filter(function(msg) {\r\n\t\t\t\t// \tif (msg.type === 1) {\r\n\t\t\t\t// \t\treturn msg.message\r\n\t\t\t\t// \t}\r\n\t\t\t\t// })\r\n\t\t\t\t// console.log(this.imgMsg)\r\n\t\t\t\tlet arr = this.imgMsg\r\n\r\n\t\t\t\tlet oldTime = ''\r\n\t\t\t\t//处理时间\r\n\t\t\t\tif (msgsArr.length !== 0) {\r\n\t\t\t\t\toldTime = msgsArr[0].createTime\r\n\t\t\t\t} else {\r\n\t\t\t\t\treturn;\r\n\t\t\t\t}\r\n\r\n\t\t\t\tmsgsArr.forEach(function(item, index) {\r\n\t\t\t\t\tlet temp = item.createTime\r\n\t\t\t\t\tif (item.type === 1) {\r\n\t\t\t\t\t\tarr.push(item.messageContent)\r\n\t\t\t\t\t}\r\n\t\t\t\t\tconsole.log(item.createTime)\r\n\t\t\t\t\tif (index === 0) {\r\n\t\t\t\t\t\titem.showTime = dateTool.chatTime(item.createTime)\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\titem.showTime = dateTool.intervalTime(oldTime, item.createTime) === '' ? '' : dateTool.chatTime(\r\n\t\t\t\t\t\t\titem.createTime)\r\n\t\t\t\t\t}\r\n\t\t\t\t\titem.createTime = new Date(item.createTime).getTime()\r\n\t\t\t\t\t oldTime = temp\r\n\t\t\t\t})\r\n\t\t\t\tif (this.queryObj.page === 1) {\r\n\t\t\t\t\tthis.msgs = msgsArr\r\n\t\t\t\t\t//处理滚动条\r\n\t\t\t\t\tthis.$nextTick(function() {\r\n\t\t\t\t\t\tthis.scrollToView = 'msg' + msgsArr[msgsArr.length - 1].createTime\r\n\t\t\t\t\t})\r\n\t\t\t\t} else {\r\n\t\t\t\t\tclearInterval(this.loading)\r\n\t\t\t\t\tthis.isLoading = false\r\n\t\t\t\t\tthis.msgs = [...msgsArr, ...this.msgs]\r\n\r\n\t\t\t\t\t// this.$nextTick(function(){\r\n\t\t\t\t\t// \tthis.scrollToView = 'msg' + msgsArr[msgsArr.length - 1].id\r\n\t\t\t\t\t// })\r\n\t\t\t\t}\r\n\t\t\t\t// this.curPage = page\r\n\r\n\t\t\t},\r\n\t\t\t//滚动顶部加载上一页\r\n\t\t\tnextPage() {\r\n\t\t\t\tconsole.log(\"下一页\")\r\n\t\t\t\t//判断是否还有数据, 且当前页是否为0\r\n\t\t\t\tif (this.queryObj.size * this.queryObj.page > this.total) {\r\n\t\t\t\t\tconsole.log(\"超过了\")\r\n\t\t\t\t\treturn;\r\n\t\t\t\t}\r\n\t\t\t\tif (this.isLoading) return;\r\n\t\t\t\t// var animation = uni.createAnimation({\r\n\t\t\t\t// \t// transformOrigin: \"50% 50%\",\r\n\t\t\t\t// \tduration: 1000,\r\n\t\t\t\t// \ttimingFunction: \"step-start\",\r\n\t\t\t\t// \t// delay: 0\r\n\t\t\t\t// })\r\n\t\t\t\t// this.animation = animation\r\n\t\t\t\tthis.queryObj.page++;\r\n\t\t\t\tthis.getChatRecords()\r\n\t\t\t\tlet i = 1\r\n\t\t\t\tlet that = this\r\n\t\t\t\t\r\n\t\t\t\t// this.loading = setInterval(function() {\r\n\t\t\t\t// \tanimation.rotate(30 * i).step()\r\n\t\t\t\t// \tthis.animationData = animation.export()\r\n\t\t\t\t// \ti++\r\n\t\t\t\t// \tif (this.isLoading) return;\r\n\t\t\t\t// \tthis.isLoading = true\r\n\t\t\t\t// \tif (i > 40) {\r\n\t\t\t\t\t\t\r\n\t\t\t\t// \t\t// let msg = [{\r\n\t\t\t\t// \t\t// \t\t\"id\": \"8\",\r\n\t\t\t\t// \t\t// \t\t\"userId\": \"2\",\r\n\t\t\t\t// \t\t// \t\t\"imgUrl\": \"../../static/example/avatar.jpg\",\r\n\t\t\t\t// \t\t// \t\t// \"message\": '../../static/example/example.jpg',\r\n\t\t\t\t// \t\t// \t\t\"message\": 'https://img-blog.csdn.net/20181002101903185?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MTc5NjYzMQ==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70',\r\n\t\t\t\t// \t\t// \t\t\"type\": 1,\r\n\t\t\t\t// \t\t// \t\t\"time\": new Date() - 1000 * 60 * 60 * 24 * 365 * 2 * 2 * 2\r\n\t\t\t\t// \t\t// \t},\r\n\t\t\t\t// \t\t// \t{\r\n\t\t\t\t// \t\t// \t\t\"id\": \"9\",\r\n\t\t\t\t// \t\t// \t\t\"userId\": \"2\",\r\n\t\t\t\t// \t\t// \t\t\"imgUrl\": \"../../static/example/avatar.jpg\",\r\n\t\t\t\t// \t\t// \t\t// \"message\": '../../static/example/example.jpg',\r\n\t\t\t\t// \t\t// \t\t\"message\": 'https://img-blog.csdn.net/20181002101903185?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MTc5NjYzMQ==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70',\r\n\t\t\t\t// \t\t// \t\t\"type\": 1,\r\n\t\t\t\t// \t\t// \t\t\"time\": new Date() - 1000 * 60 * 60 * 24 * 365 * 2 * 2 * 2 * 2\r\n\t\t\t\t// \t\t// \t}\r\n\t\t\t\t// \t // ]\r\n\t\t\t\t// \t console.log(\"参数:\" + this.queryObj.page)\r\n\t\t\t\t// \t this.queryObj.page++;\r\n\t\t\t\t// \t this.getChatRecords()\r\n\t\t\t\t// \t //this.getMsg(msg)\r\n\t\t\t\t// \t}\r\n\t\t\t\t// }.bind(this), 100)\r\n\t\t\t},\r\n\t\t\tgetTime(date, arr, index) {\r\n\t\t\t\t// let arr = this.msgs\r\n\t\t\t\t//console.log(arr[index - 1].time)\r\n\t\t\t\tconsole.log(\"getTime index:\"+index)\r\n\t\t\t\tif (index === 0) {\r\n\t\t\t\t\treturn dateTool.chatTime(date)\r\n\t\t\t\t} else {\r\n\t\t\t\t\treturn dateTool.intervalTime(arr[index - 1].createTime, date) === '' ? '' : dateTool.chatTime(date)\r\n\t\t\t\t}\r\n\t\t\t},\r\n\t\t\t//处理时间\r\n\t\t\tchangeTime(date) {\r\n\t\t\t\treturn dateTool.chatTime(date)\r\n\t\t\t},\r\n\t\t\t//预览图片\r\n\t\t\tpreviewImg(img) {\r\n\t\t\t\tlet index = this.imgMsg.findIndex(function(item) {\r\n\r\n\t\t\t\t\tif (img === item) {\r\n\t\t\t\t\t\treturn true\r\n\t\t\t\t\t}\r\n\t\t\t\t})\r\n\t\t\t\tconsole.log(index)\r\n\t\t\t\tuni.previewImage({\r\n\t\t\t\t\tcurrent: index,\r\n\t\t\t\t\turls: [''],\r\n\t\t\t\t\tsuccess() {\r\n\t\t\t\t\t\tconsole.log(\"成功了\")\r\n\t\t\t\t\t},\r\n\t\t\t\t\tfail(e) {\r\n\t\t\t\t\t\tconsole.log(\"失败了:\" + JSON.stringify(e))\r\n\t\t\t\t\t},\r\n\t\t\t\t})\r\n\r\n\r\n\t\t\t},\r\n\t\t\tupdateHeight(height) {\r\n\t\t\t\tconsole.log(\"高度为:\" + height)\r\n\t\t\t\tthis.paddingHeight = height\r\n\t\t\t\tthis.goToBottom()\r\n\t\t\t},\r\n\t\t\t//滚动到底部\r\n\t\t\tgoToBottom() {\r\n\t\t\t\tconsole.log(\"最后一个：\" + this.msgs.length)\r\n\t\t\t\tthis.scrollToView = ''\r\n\t\t\t\tsetTimeout(() => {\r\n\t\t\t\t\tthis.$nextTick(function() {\r\n\t\t\t\t\t\tthis.scrollToView = 'msg' + this.msgs[this.msgs.length - 1].createTime\r\n\t\t\t\t\t})\r\n\t\t\t\t}, 0)\r\n\r\n\t\t\t},\r\n\t\t\t//发送消息\r\n\t\t\tinput(msg) {\r\n\t\t\t\t\r\n\t\t\t\tlet message = {\r\n\t\t\t\t\t//\"id\": res.data.data,\r\n\t\t\t\t\t\"senderId\": this.userinfo.openId,\r\n\t\t\t\t\t\"senderHeadPortrait\": this.userinfo.avatar,\r\n\t\t\t\t\t\"messageContent\": msg.content,\r\n\t\t\t\t\t\"inboxHash\": this.queryObj.inboxHash,\r\n\t\t\t\t\t// \"message\": 'https://img-blog.csdn.net/20181002101903185?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MTc5NjYzMQ==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70',\r\n\t\t\t\t\t\"messageType\": 0,\r\n\t\t\t\t\t\"createTime\": new Date().getTime()\r\n\t\t\t\t}\r\n\t\t\t\tthis.msgs.push(message)\r\n\t\t\t\t//处理时间\r\n\t\t\t\tlet index = this.msgs.length === 0 ? 0 : this.msgs.length - 1\r\n\t\t\t\tmessage.showTime = this.getTime(message.createTime, this.msgs, index)\r\n\t\t\t\tthis.goToBottom()\r\n\t\t\t\tconsole.log(msg.messageContent)\r\n\t\t\t\t\r\n\t\t\t\tlet queryObj = {\r\n\t\t\t\t\t\"type\": 1,\r\n\t\t\t\t\t\"chatRecordSendDTO\": {\r\n\t\t\t\t\t\t\"inboxHash\": this.queryObj.inboxHash,\r\n\t\t\t\t\t\t\"messageContent\": msg.content,\r\n\t\t\t\t\t\t\"messageType\": 0,\r\n\t\t\t\t\t\t\"createTime\": new Date().getTime()\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\tlet that = this\r\n\t\t\t\tthis.sendSocketMessage(JSON.stringify(queryObj)).then(res => {\r\n\t\t\t\t\tconsole.log(\"sendRes:\" + JSON.stringify(res))\r\n\t\t\t\t\tconsole.log(\"发送成功\")\r\n\t\t\t\t\t\r\n\t\t\t\t}).catch(res => {\r\n\t\t\t\t\tconsole.log(\"发送失败\")\r\n\t\t\t\t\tconsole.log(res)\r\n\t\t\t\t})\r\n\t\t\t\t// if (msg.type === 1) {\r\n\t\t\t\t// \tthis.imgMsg.push(msg.content)\r\n\t\t\t\t// }\r\n\r\n\t\t\t\t\r\n\t\t\t},\r\n\t\t\tuploadPhoto(filePaths) {\r\n\t\t\t\tvar self = this;\r\n\t\t\t\tlet length = this.msgs.length\r\n\t\t\t\tfilePaths.forEach(function(item) {\r\n\t\t\t\t\tlet message = {\r\n\t\t\t\t\t\t\"inboxHash\": self.queryObj.inboxHash,\r\n\t\t\t\t\t\t\"senderId\": self.userinfo.openId,\r\n\t\t\t\t\t\t\"senderHeadPortrait\": self.userinfo.avatar,\r\n\t\t\t\t\t\t\"messageContent\": item,\r\n\t\t\t\t\t\t// \"message\": 'https://img-blog.csdn.net/20181002101903185?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MTc5NjYzMQ==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70',\r\n\t\t\t\t\t\t\"messageType\": 1,\r\n\t\t\t\t\t\t\"createTime\": new Date().getTime()\r\n\t\t\t\t\t}\r\n\t\t\t\t\tself.msgs.push(message)\r\n\t\t\t\t\tlet index = self.msgs.length === 0? 0 : self.msgs.length - 1\r\n\t\t\t\t\tmessage.showTime = self.getTime(message.createTime, self.msgs, index)\r\n\t\t\t\t\tself.imgMsg.push(item)\r\n\t\t\t\t\t\r\n\t\t\t\t\tlet queryObj = {\r\n\t\t\t\t\t\t\"type\": 1,\r\n\t\t\t\t\t\t\"chatRecordSendDTO\": {\r\n\t\t\t\t\t\t\t\"inboxHash\": self.queryObj.inboxHash,\r\n\t\t\t\t\t\t\t\"messageContent\": item,\r\n\t\t\t\t\t\t\t\"messageType\": 1,\r\n\t\t\t\t\t\t\t\"createTime\": new Date().getTime()\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t\t\r\n\t\t\t\t\tself.sendSocketMessage(JSON.stringify(queryObj)).then(res => {\r\n\t\t\t\t\t\tconsole.log(\"sendRes:\" + JSON.stringify(res))\r\n\t\t\t\t\t\tconsole.log(\"发送成功\")\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t}).catch(res => {\r\n\t\t\t\t\t\tconsole.log(\"发送失败\")\r\n\t\t\t\t\t\tconsole.log(res)\r\n\t\t\t\t\t})\r\n\t\t\t\t})\r\n\t\t\t\tthis.goToBottom()\r\n\t\t\t},\r\n\t\t\tconnectSocket() {\r\n\t\t\t\tlet that = this\r\n\t\t\t\tthis.socketTask = uni.connectSocket({\r\n\t\t\t\t\turl: 'ws://127.0.0.1:8183/campus_run',\r\n\t\t\t\t\theader: {\r\n\t\t\t\t\t\t'Authorization': that.token,\r\n\t\t\t\t\t\t'SocketScene': 'CHAT_RECORD'\r\n\t\t\t\t\t},\r\n\t\t\t\t\t// header: {\r\n\t\t\t\t\t// \t\t'content-type': 'application/json'\r\n\t\t\t\t\t// \t},\r\n\t\t\t\t\tdata() {\r\n\t\t\t\t\t\treturn {\r\n\t\t\t\t\t\t\ttype: '0'\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t},\r\n\t\t\t\t\tcomplete: (e) => {\r\n\t\t\t\t\t\tconsole.log(e)\r\n\t\t\t\t\t},\r\n\t\t\t\t\tfail: (e) => {\r\n\t\t\t\t\t\tconsole.log(e)\r\n\t\t\t\t\t},\r\n\t\t\t\t\tsuccess: (e) => {\r\n\t\t\t\t\t\tconsole.log(e)\r\n\t\t\t\t\t}\r\n\t\t\t\t})\r\n\r\n\t\t\t\tthis.socketTask.onOpen(function(res) {\r\n\t\t\t\t\tconsole.log(\"WebSocket连接已打开\")\r\n\t\t\t\t\tclearInterval(that.reconnectTimer)\r\n\t\t\t\t\t//定期发送心跳\r\n\t\t\t\t\tthat.heart()\r\n\t\t\t\t})\r\n\r\n\t\t\t\tthis.socketTask.onMessage(function(res) {\r\n\t\t\t\t\t//对获取内容操作\r\n\t\t\t\t\tlet obj = JSON.parse(res.data)\r\n\t\t\t\t\tlet msg = obj.data.data\r\n\t\t\t\t\tif (msg === undefined) return;\r\n\t\t\t\t\t\r\n\t\t\t\t\t// console.log(\"我收到消息:\" + JSON.stringify(msg))\r\n\t\t\t\t\t// let arr = []\r\n\t\t\t\t\t// arr.push(msg)\r\n\t\t\t\t\tthat.msgs.push(msg)\r\n\t\t\t\t\tlet index = that.msgs.length === 0? 0 : that.msgs.length - 1\r\n\t\t\t\t\tmsg.showTime = that.getTime(msg.createTime, that.msgs, index)\r\n\t\t\t\t\t\r\n\t\t\t\t\tif (msg.messageType === 1) {\r\n\t\t\t\t\t\tthat.imgMsg.push(msg.messageContent)\r\n\t\t\t\t\t}\r\n\t\t\t\t\tthat.goToBottom()\r\n\t\t\t\t\t//that.getMsg(arr)\r\n\t\t\t\t\t\r\n\t\t\t\t})\r\n\r\n\t\t\t\t//1. 服务器关闭，onError -> onClose 重连\r\n\t\t\t\t//2. 服务器关闭通道， onClose 重连\r\n\t\t\t\t//3. wss, onError-> onClose 重连\r\n\t\t\t\tthis.socketTask.onError(function(res) {\r\n\t\t\t\t\tconsole.log(\"WebSocket连接打开失败，请检查\")\r\n\t\t\t\t\tconsole.log(res)\r\n\t\t\t\t\tthat.socketOpen = false\r\n\t\t\t\t\t//进入重新连接\r\n\t\t\t\t\t// that.reconnect()\r\n\t\t\t\t})\r\n\r\n\t\t\t\tthis.socketTask.onClose((e) => {\r\n\t\t\t\t\tconsole.log(\"WebSocket连接关闭\")\r\n\t\t\t\t\tclearInterval(that.timer)\r\n\t\t\t\t\tthat.timer = ''\r\n\r\n\t\t\t\t\t//如果不是主动关闭的就重新连接\r\n\t\t\t\t\t//socketOpen在连接成功后应该一直是true, 只有onError是false，false的话就要重连\r\n\t\t\t\t\tif (!that.socketOpen && !that.isUnLoad) {\r\n\t\t\t\t\t\tconsole.log(\"不是主动关闭的\")\r\n\t\t\t\t\t\tthat.reconnect()\r\n\t\t\t\t\t}\r\n\t\t\t\t})\r\n\r\n\r\n\t\t\t},\r\n\t\t\t//进入重新连接\r\n\t\t\treconnect() {\r\n\t\t\t\tconsole.log(\"进入断线重连\")\r\n\t\t\t\tthis.socketTask = ''\r\n\t\t\t\tif (this.reconnectTimer === '') {\r\n\t\t\t\t\tconsole.log(\"执行了1次\")\r\n\t\t\t\t\tthis.reconnectTimer = setInterval(() => {\r\n\t\t\t\t\t\tthis.connectSocket()\r\n\t\t\t\t\t}, 1000)\r\n\t\t\t\t}\r\n\t\t\t\t// this.connectSocket()\r\n\t\t\t},\r\n\t\t\t//发送消息\r\n\t\t\tsendSocketMessage(msg) {\r\n\t\t\t\tconsole.log(\"发送信息\")\r\n\t\t\t\tconsole.log(JSON.stringify(msg))\r\n\t\t\t\tconst that = this\r\n\t\t\t\treturn new Promise((resolve, reject) => {\r\n\t\t\t\t\tthis.socketTask.send({\r\n\t\t\t\t\t\theader: {\r\n\t\t\t\t\t\t\t'Authorization': that.token,\r\n\t\t\t\t\t\t\t'SocketScene': 'CHAT_RECORD'\r\n\t\t\t\t\t\t},\r\n\t\t\t\t\t\tdata: msg,\r\n\t\t\t\t\t\tsuccess(res) {\r\n\t\t\t\t\t\t\tconsole.log(\"发送成功\")\r\n\t\t\t\t\t\t\tresolve(res)\r\n\t\t\t\t\t\t},\r\n\t\t\t\t\t\tfail(res) {\r\n\t\t\t\t\t\t\tconsole.log(\"发送失败\")\r\n\t\t\t\t\t\t\tconsole.log(res)\r\n\t\t\t\t\t\t\treject(res)\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t})\r\n\t\t\t\t})\r\n\t\t\t},\r\n\t\t\theart() {\r\n\t\t\t\tlet that = this\r\n\t\t\t\tclearInterval(this.timer)\r\n\t\t\t\tthis.timer = ''\r\n\t\t\t\tlet msg = {\r\n\t\t\t\t\t\"type\": \"3\"\r\n\t\t\t\t}\r\n\t\t\t\tthis.timer = setInterval(() => {\r\n\t\t\t\t\tthat.sendSocketMessage(JSON.stringify(msg)).then(res => {\r\n\t\t\t\t\t\tconsole.log(\"心跳成功\")\r\n\t\t\t\t\t}).catch(res => {\r\n\t\t\t\t\t\tconsole.log(\"发送失败\")\r\n\t\t\t\t\t\tconsole.log(res)\r\n\t\t\t\t\t})\r\n\t\t\t\t}, 4000)\r\n\t\t\t},\r\n\t\t\t//主动关闭连接\r\n\t\t\tcloseSocket() {\r\n\t\t\t\t//已经关了\r\n\t\t\t\tif (!this.socketOpen) {\r\n\t\t\t\t\treturn\r\n\t\t\t\t}\r\n\t\t\t\tthis.socketTask.closeSocket({\r\n\t\t\t\t\tsuccess(e) {\r\n\t\t\t\t\t\tconsole.log(\"成功关闭连接\")\r\n\t\t\t\t\t\tconsole.log(e)\r\n\t\t\t\t\t},\r\n\t\t\t\t\tfail(e) {\r\n\t\t\t\t\t\tconsole.log(\"关闭连接失败\")\r\n\t\t\t\t\t\tconsole.log(e)\r\n\t\t\t\t\t}\r\n\t\t\t\t})\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n</script>\r\n\r\n<style lang=\"scss\">\r\n\t.chat {\r\n\t\theight: 100%;\r\n\r\n\t\t// .pad {\r\n\t\t// \theight: var(--status-bar-height);\r\n\t\t// \twidth: 100%;\r\n\t\t// }\r\n\t\t.chat-main {\r\n\t\t\tpadding-left: 32rpx;\r\n\t\t\tpadding-right: 32rpx;\r\n\t\t\tpadding-top: 17rpx;\r\n\t\t\t// padding-bottom: 300px;\r\n\t\t\tdisplay: flex;\r\n\t\t\tflex-direction: column;\r\n\r\n\t\t\t.loading {\r\n\t\t\t\ttext-align: center;\r\n\r\n\t\t\t\t.loading-image {\r\n\t\t\t\t\twidth: 60rpx;\r\n\t\t\t\t\theight: 60rpx;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\t.chat-ls {\r\n\t\t\t\t.chat-time {\r\n\t\t\t\t\tfont-size: 24rpx;\r\n\t\t\t\t\tcolor: rgba(39, 40, 50, 0.3);\r\n\t\t\t\t\tline-height: 34rpx;\r\n\t\t\t\t\tpadding: 20rpx 0;\r\n\t\t\t\t\ttext-align: center;\r\n\t\t\t\t}\r\n\r\n\t\t\t\t.msg-m {\r\n\t\t\t\t\tdisplay: flex;\r\n\t\t\t\t\tpadding: 20rpx 0;\r\n\r\n\t\t\t\t\t.user-img {\r\n\t\t\t\t\t\tflex: none;\r\n\t\t\t\t\t\twidth: 80rpx;\r\n\t\t\t\t\t\theight: 80rpx;\r\n\t\t\t\t\t\tborder-radius: 20rpx;\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\t.message {\r\n\t\t\t\t\t\tdisplay: flex;\r\n\t\t\t\t\t\tmax-width: 480rpx;\r\n\r\n\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\t.msg-text {\r\n\t\t\t\t\t\tfont-size: 32rpx;\r\n\t\t\t\t\t\tline-height: 44rpx;\r\n\t\t\t\t\t\tcolor: rgba(39, 40, 50, 1);\r\n\t\t\t\t\t\tpadding: 18rpx 24rpx;\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\t.msg-img {\r\n\t\t\t\t\t\tmax-width: 400rpx;\r\n\t\t\t\t\t\tborder-radius: 20rpx;\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\r\n\t\t\t\t.msg-left {\r\n\t\t\t\t\tdisplay: flex;\r\n\t\t\t\t\tflex-direction: row;\r\n\r\n\t\t\t\t\t.msg-text {\r\n\t\t\t\t\t\tmargin-left: 16rpx;\r\n\t\t\t\t\t\tbackground-color: #fff;\r\n\t\t\t\t\t\tborder-radius: 0px 20px 20rpx 20px;\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\t.msg-img {\r\n\t\t\t\t\t\tmargin-left: 16rpx;\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\r\n\t\t\t\t.msg-right {\r\n\t\t\t\t\tdisplay: flex;\r\n\t\t\t\t\tflex-direction: row-reverse;\r\n\r\n\t\t\t\t\t.msg-text {\r\n\t\t\t\t\t\tmargin-right: 16rpx;\r\n\t\t\t\t\t\tbackground-color: lightblue;\r\n\t\t\t\t\t\tborder-radius: 20rpx 0px 20rpx 20rpx;\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\t.msg-img {\r\n\t\t\t\t\t\tmargin-right: 16rpx;\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t}\r\n\r\n\t.send {\r\n\t\theight: 200rpx;\r\n\t}\r\n</style>\n","import mod from \"-!../../../HBuilderX.3.6.4.20220922/HBuilderX/plugins/uniapp-cli/node_modules/mini-css-extract-plugin/dist/loader.js??ref--8-oneOf-1-0!../../../HBuilderX.3.6.4.20220922/HBuilderX/plugins/uniapp-cli/node_modules/css-loader/dist/cjs.js??ref--8-oneOf-1-1!../../../HBuilderX.3.6.4.20220922/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/vue-cli-plugin-uni/packages/vue-loader/lib/loaders/stylePostLoader.js!../../../HBuilderX.3.6.4.20220922/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/vue-cli-plugin-uni/packages/webpack-preprocess-loader/index.js??ref--8-oneOf-1-2!../../../HBuilderX.3.6.4.20220922/HBuilderX/plugins/uniapp-cli/node_modules/postcss-loader/src/index.js??ref--8-oneOf-1-3!../../../HBuilderX.3.6.4.20220922/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/vue-cli-plugin-uni/packages/sass-loader/dist/cjs.js??ref--8-oneOf-1-4!../../../HBuilderX.3.6.4.20220922/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/vue-cli-plugin-uni/packages/webpack-preprocess-loader/index.js??ref--8-oneOf-1-5!../../../HBuilderX.3.6.4.20220922/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/vue-cli-plugin-uni/packages/vue-loader/lib/index.js??vue-loader-options!../../../HBuilderX.3.6.4.20220922/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/webpack-uni-mp-loader/lib/style.js!./chat.vue?vue&type=style&index=0&lang=scss&\"; export default mod; export * from \"-!../../../HBuilderX.3.6.4.20220922/HBuilderX/plugins/uniapp-cli/node_modules/mini-css-extract-plugin/dist/loader.js??ref--8-oneOf-1-0!../../../HBuilderX.3.6.4.20220922/HBuilderX/plugins/uniapp-cli/node_modules/css-loader/dist/cjs.js??ref--8-oneOf-1-1!../../../HBuilderX.3.6.4.20220922/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/vue-cli-plugin-uni/packages/vue-loader/lib/loaders/stylePostLoader.js!../../../HBuilderX.3.6.4.20220922/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/vue-cli-plugin-uni/packages/webpack-preprocess-loader/index.js??ref--8-oneOf-1-2!../../../HBuilderX.3.6.4.20220922/HBuilderX/plugins/uniapp-cli/node_modules/postcss-loader/src/index.js??ref--8-oneOf-1-3!../../../HBuilderX.3.6.4.20220922/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/vue-cli-plugin-uni/packages/sass-loader/dist/cjs.js??ref--8-oneOf-1-4!../../../HBuilderX.3.6.4.20220922/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/vue-cli-plugin-uni/packages/webpack-preprocess-loader/index.js??ref--8-oneOf-1-5!../../../HBuilderX.3.6.4.20220922/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/vue-cli-plugin-uni/packages/vue-loader/lib/index.js??vue-loader-options!../../../HBuilderX.3.6.4.20220922/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/webpack-uni-mp-loader/lib/style.js!./chat.vue?vue&type=style&index=0&lang=scss&\"","// extracted by mini-css-extract-plugin\n    if(module.hot) {\n      // 1679134566900\n      var cssReload = require(\"D:/hbuilder/HBuilderX.3.6.4.20220922/HBuilderX/plugins/uniapp-cli/node_modules/mini-css-extract-plugin/dist/hmr/hotModuleReplacement.js\")(module.id, {\"hmr\":true,\"publicPath\":\"../../\",\"locals\":false});\n      module.hot.dispose(cssReload);\n      module.hot.accept(undefined, cssReload);\n    }\n  "],"sourceRoot":""}